on:
  push:
    branches: [ main ]

jobs:
  build-on-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Step 1 - Checkout main branch from GitHub 
        uses: actions/checkout@v2

      - name: Step 2 - List all files in the repository after checkout
        run: |
          ls -al

      - name: Step 3 - Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
    
      - name: Step 4 - Build Maven Project
        run: |
          mvn -B package --file pom.xml

      - name: Step 5 - List files in the root directory after build
        run: |
          ls -al

      - name: Step 6 - Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Step 7 - Login to Amazon ECR
        env:
          AWS_REGION: us-east-1  # Change to your desired region
        run: |
          echo ${{ secrets.AWS_ACCESS_KEY_ID }} | aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin 508511762335.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Step 8 - Build Docker Image
        run: |
          docker build -t 508511762335.dkr.ecr.$AWS_REGION.amazonaws.com/github-action-ecr:latest .

      - name: Step 9 - Push Docker Image to ECR
        run: |
          docker push 508511762335.dkr.ecr.$AWS_REGION.amazonaws.com/github-action-ecr:latest

      - name: Step 10 - List Docker Images
        run: |
          docker images
